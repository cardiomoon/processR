if(length(unique(data[[modx]]))<6) {
modx.values=unique(data[[modx]])
} else if(rangemode==1){
modx.values=mean(data[[modx]],na.rm=T)+c(-1,1)*sd(data[[modx]],na.rm=T)
} else{
modx.values=quantile(data[[modx]],probs=c(0.16,0.84),type=6)
}
}
df1=calEquation(fit,modx.values = modx.values)
df1[[modx]]=modx.values
df=tidyr::crossing(pred.values,modx.values)
names(df)=c(pred,modx)
df<-dplyr::left_join(df,df1)
df[[dep]]=df$slope*df[[pred]]+df$intercept
df<-df[c(pred,modx,dep)]
colnames(df)=c(paste0(pred,"(X)"),paste0(modx,("(W)")),"\u0176")
df[]=lapply(df,myformat,digits)
coef=round(fit$coef,digits)
temp=paste0("\u0176 = ",coef[1], coef2str(coef[2]),"X",
coef2str(coef[3]),"W",coef2str(coef[4]),"XW")
attr(df,"eq")=temp
df
}
fit=lm(justify~skeptic*frame,data=disaster)
modSummary(fit)
class(df)="modSummary"
#' Make tbale summarizing moderation effect
#'@param pred name of predictor variable
#'@param modx name of moderator variable
#'@param pred.values Values of predictor variables
#'@param modx.values Values of modifier variables
#'@param rangemode integer. 1 or 2
#'@param digits integer indicating the number of decimal places
#'@examples
#'fit=lm(justify~skeptic*frame,data=disaster)
#'modSummary(fit)
modSummary=function(fit,pred=NULL,modx=NULL,pred.values=NULL,modx.values=NULL,
rangemode=2,digits=3){
data=fit$model
dep=colnames(data)[1]
if(is.null(pred)) pred=colnames(data)[2]
if(is.null(modx)) modx=colnames(data)[3]
if(is.null(pred.values)){
if(rangemode==1) {
pred.values=mean(data[[pred]],na.rm=TRUE)+c(-1,0,1)*sd(data[[pred]],na.rm=TRUE)
} else if(rangemode==2) {
pred.values=quantile(data[[pred]],probs=c(0.16,0.5,0.84),type=6)
}
}
if(is.null(modx.values)){
if(length(unique(data[[modx]]))<6) {
modx.values=unique(data[[modx]])
} else if(rangemode==1){
modx.values=mean(data[[modx]],na.rm=T)+c(-1,1)*sd(data[[modx]],na.rm=T)
} else{
modx.values=quantile(data[[modx]],probs=c(0.16,0.84),type=6)
}
}
df1=calEquation(fit,modx.values = modx.values)
df1[[modx]]=modx.values
df=tidyr::crossing(pred.values,modx.values)
names(df)=c(pred,modx)
df<-dplyr::left_join(df,df1)
df[[dep]]=df$slope*df[[pred]]+df$intercept
df<-df[c(pred,modx,dep)]
colnames(df)=c(paste0(pred,"(X)"),paste0(modx,("(W)")),"\u0176")
df[]=lapply(df,myformat,digits)
coef=round(fit$coef,digits)
temp=paste0("\u0176 = ",coef[1], coef2str(coef[2]),"X",
coef2str(coef[3]),"W",coef2str(coef[4]),"XW")
attr(df,"eq")=temp
class(df)="modSummary"
df
}
fit=lm(justify~skeptic*frame,data=disaster)
modSummary(fit)
#' Make tbale summarizing moderation effect
#'@param pred name of predictor variable
#'@param modx name of moderator variable
#'@param pred.values Values of predictor variables
#'@param modx.values Values of modifier variables
#'@param rangemode integer. 1 or 2
#'@param digits integer indicating the number of decimal places
#'@examples
#'fit=lm(justify~skeptic*frame,data=disaster)
#'modSummary(fit)
modSummary=function(fit,pred=NULL,modx=NULL,pred.values=NULL,modx.values=NULL,
rangemode=2,digits=3){
data=fit$model
dep=colnames(data)[1]
if(is.null(pred)) pred=colnames(data)[2]
if(is.null(modx)) modx=colnames(data)[3]
if(is.null(pred.values)){
if(rangemode==1) {
pred.values=mean(data[[pred]],na.rm=TRUE)+c(-1,0,1)*sd(data[[pred]],na.rm=TRUE)
} else if(rangemode==2) {
pred.values=quantile(data[[pred]],probs=c(0.16,0.5,0.84),type=6)
}
}
if(is.null(modx.values)){
if(length(unique(data[[modx]]))<6) {
modx.values=unique(data[[modx]])
} else if(rangemode==1){
modx.values=mean(data[[modx]],na.rm=T)+c(-1,1)*sd(data[[modx]],na.rm=T)
} else{
modx.values=quantile(data[[modx]],probs=c(0.16,0.84),type=6)
}
}
df1=calEquation(fit,modx.values = modx.values)
df1[[modx]]=modx.values
df=tidyr::crossing(pred.values,modx.values)
names(df)=c(pred,modx)
df<-dplyr::left_join(df,df1)
df[[dep]]=df$slope*df[[pred]]+df$intercept
df<-df[c(pred,modx,dep)]
colnames(df)=c(paste0(pred,"(X)"),paste0(modx,("(W)")),"\u0176")
df[]=lapply(df,myformat,digits)
coef=round(fit$coef,digits)
temp=paste0("\u0176 = ",coef[1], coef2str(coef[2]),"X",
coef2str(coef[3]),"W",coef2str(coef[4]),"XW")
attr(df,"eq")=temp
class(df)=c("modSummary","data.frame")
df
}
fit=lm(justify~skeptic*frame,data=disaster)
modSummary(fit)
print.modSummary=function(x,...){
cat("\n\nSummary of moderation effect\n")
cat("\n\nEquation=",attr(x,"eq"),"\n")
x
}
fit=lm(justify~skeptic*frame,data=disaster)
modSummary(fit)
fit=lm(justify~skeptic*frame,data=disaster)
print.modSummary=function(x,...){
cat("\n\nSummary of moderation effect\n")
cat("\n\nEquation=",attr(x,"eq"),"\n")
print(x)
}
fit=lm(justify~skeptic*frame,data=disaster)
modSummary(fit)
print.modSummary=function(x,...){
cat("\n\nSummary of moderation effect\n")
cat("\n\nEquation=",attr(x,"eq"),"\n")
class(x)="data.frame"
print(x)
}
fit=lm(justify~skeptic*frame,data=disaster)
modSummary(fit)
print.modSummary=function(x,...){
cat("\n\nSummary of moderation effect\n")
cat("Equation\n",attr(x,"eq"),"\n\n")
class(x)="data.frame"
print(x)
}
fit=lm(justify~skeptic*frame,data=disaster)
modSummary(fit)
print.modSummary=function(x,...){
cat("\n\nSummary of moderation effect\n")
cat("\nEquation: ",attr(x,"eq"),"\n\n")
class(x)="data.frame"
print(x)
}
fit=lm(justify~skeptic*frame,data=disaster)
modSummary(fit)
print.modSummary=function(x,...){
cat("\nSummary of moderation effect\n")
cat("\nEquation: ",attr(x,"eq"),"\n\n")
class(x)="data.frame"
print(x)
}
fit=lm(justify~skeptic*frame,data=disaster)
modSummary(fit)
modSummaryTable=function(x,...){
df2flextable(x,...)
}
fit=lm(justify~skeptic*frame,data=disaster)
modSummary(fit)
modSummaryTable=function(x,...){
if("lm" %in% class(x)) x=modSummary(x)
df2flextable(x,...)
}
modSummaryTable(fit)
modSummaryTable=function(x,...){
if("lm" %in% class(x)) x=modSummary(x)
rrtable::df2flextable(x,...)
}
modSummaryTable(fit)
modSummaryTable(fit,vanilla=TRUE)
modSummaryTable=function(x,...){
if("lm" %in% class(x)) x=modSummary(x,...)
rrtable::df2flextable(x,...)
}
modSummaryTable(fit,vanilla=TRUE)
modSummaryTable=function(x,...){
if("lm" %in% class(x)) x=modSummary(x)
rrtable::df2flextable(x,...)
}
modSummaryTable(fit,vanilla=TRUE)
modSummaryTable=function(x,vanilla=TRUE,...){
if("lm" %in% class(x)) x=modSummary(x,...)
rrtable::df2flextable(x,vanilla=vanilla)
}
modSummaryTable(fit,vanilla=TRUE)
modSummaryTable(fit)
modSummaryTable=function(x,vanilla=TRUE,...){
if("lm" %in% class(x)) x=modSummary(x,...)
rrtable::df2flextable(x,vanilla=vanilla) %>%
add_footer_lines(attr(x,"eq") )) %>%
align(align="right",part="footer")
}
modSummaryTable=function(x,vanilla=TRUE,...){
if("lm" %in% class(x)) x=modSummary(x,...)
rrtable::df2flextable(x,vanilla=vanilla) %>%
add_footer_lines(attr(x,"eq")) %>%
align(align="right",part="footer")
}
modSummaryTable(fit)
devtools::document()
fit=lm(justify~skeptic*frame,data=disaster)
library(processR)
modSummaryTable(fit)
fit=lm(justify~skeptic*frame,data=disaster)
modSummaryTable(fit)
devtools::documnet()
devtools::document()
devtools::check()
devtools::document()
devtools::check()
fit=lm(justify~skeptic*frame,data=disaster)
modSummaryTable(fit)
source('~/Documents/ownCloud/Documents/processR/R/modSummary.R', echo=TRUE)
fit=lm(justify~skeptic*frame,data=disaster)
modSummary(fit)
devtools::document()
devtools::check()
library(processR)
data2HTML
rrtable::data2HTML
devtools::document()
devtools::check()
library(processR)
devtools::document()
devtools::check()
fit=lm(govact~negemot*age+posemot+ideology+sex,data=glbwarm)
condPlot(fit,hjust=c(-0.1,-0.1,1.1))
condPlot(fit,modx.values=c(30,70),hjust=c(-0.1,-0.1,1.1))
condPlot(fit,mode=2,modx.values=c(30,50,70),xpos=0.2)
condPlot(fit,mode=2,xpos=0.2)
condPlot(fit,mode=3,xpos=0.5,hjust=c(-0.1,1.1))
condPlot(fit,pred.values=c(2,3,4),mode=3,xpos=0.6)
#'condPlot(fit,rangemode=2,xpos=0.6)
#'condPlot(fit,mode=2,xpos=0.5)
#'condPlot(fit,mode=3,rangemode=2)
#'fit=lm(govact~negemot*age+posemot+ideology+sex,data=glbwarm)
#'condPlot(fit,hjust=c(-0.1,-0.1,1.1))
#'condPlot(fit,modx.values=c(30,70),hjust=c(-0.1,-0.1,1.1))
#'condPlot(fit,mode=2,modx.values=c(30,50,70),xpos=0.2)
#'condPlot(fit,mode=2,xpos=0.2)
#'condPlot(fit,mode=3,xpos=0.5,hjust=c(-0.1,1.1))
#'condPlot(fit,pred.values=c(2,3,4),mode=3,xpos=0.6)
condPlot=function(fit,pred=NULL,modx=NULL,pred.values=NULL,modx.values=NULL,labels=NULL,
mode=1,rangemode=1,ypos=NULL,hjust=NULL,linecolor="gray60",linetype=2,
linesize=1,arrowsize=1,digits=3,...){
# fit=lm(govact~negemot*age+posemot+ideology+sex,data=glbwarm)
# pred=NULL;modx=NULL;pred.values=NULL;modx.values=NULL
# mode=2;rangemode=2;digits=3
# # modx.values=c(30,70)
data=fit$model
dep=colnames(data)[1]
if(is.null(pred)) pred=colnames(data)[2]
if(is.null(modx)) modx=colnames(data)[3]
if(length(colnames(data)[3])>3) {
mod2=colnames(data)[4]
} else {
mod2=NULL
}
if(mode==1){
if(is.null(pred.values)){
if(rangemode==1) {
pred.values=mean(data[[pred]],na.rm=TRUE)+c(-1,0,1)*sd(data[[pred]],na.rm=TRUE)
} else if(rangemode==2) {
pred.values=quantile(data[[pred]],probs=c(0.16,0.5,0.84),type=6)
}
}
coef<-pvalue<-c()
for(i in seq_along(pred.values)){
equation=deparse(fit$call)
temp=stringr::str_replace(equation,pred,paste0("I(",pred,"-",pred.values[i],")"))
fit1=eval(parse(text=temp))
coef=c(coef,fit1$coef[3])
pvalue=c(pvalue,summary(fit1)$coef[3,4])
}
effectDf=data.frame(pred.values,coef,pvalue)
colnames(effectDf)[1]="x"
effectDf
if(is.null(modx.values)){
if(length(unique(data[[modx]]))<6) {
modx.values=unique(data[[modx]])
} else if(rangemode==1){
modx.values=mean(data[[modx]],na.rm=T)+c(-1,1)*sd(data[[modx]],na.rm=T)
} else{
modx.values=quantile(data[[modx]],probs=c(0.16,0.84),type=6)
}
}
modx.values=modx.values[c(1,length(modx.values))]
p=ggplot(data,aes_string(x=pred,y=dep))
df1=calEquation(fit,modx.values = modx.values)
df1
if(!is.null(labels)){
if(nrow(df1)==length(labels)) df1$label=labels
}
# p<-add_lines(p,df1)
p<-add_lines(p,df1,size=linesize,...)
p
info=getAspectRatio(p)
ratio=info$ratio
df1$slope2=df1$slope*ratio
df1$radian=atan(df1$slope2)
df1$angle=df1$radian*180/pi
df1[[modx]]=modx.values
df1
df=tidyr::crossing(pred.values,modx.values)
names(df)=c(pred,modx)
df
df<-dplyr::left_join(df,df1)
df[[dep]]=df$slope*df[[pred]]+df$intercept
df
df<-df[c(pred,modx,dep)]
df %>% spread(key=2,value=3) -> df2
colnames(df2)=c("x","y","yend")
df2
df3<-left_join(effectDf,df2)
df3$coef=myformat(df3$coef,digits)
df3$label3=paste0("italic(W) ==",round(df3$x,digits))
df3$p1=myformat(df3$pvalue,digits=3)
df3$p1=pformat(df3$p1)
df3$p2=ifelse(df3$p1=="0.000","< 0.001",paste0("== ",df3$p1))
df3$label=paste0("theta[italic(X) %->% italic(Y)] == ",df3$coef," ( italic(p) ",df3$p2,")")
df3$angle1=df1$angle[1]
df3$angle2=df1$angle[2]
df3$vjust1=ifelse(df3$y>df3$yend,1.2,-0.2)
df3$vjust2=ifelse(df3$y>df3$yend,-0.2,1.2)
df3$y1=(df3$y+df3$yend)/2
df3$labely=df3$yend
if(!is.null(ypos)){
if(length(ypos)==1) ypos=rep(ypos,nrow(df3))
for(i in seq_along(ypos)){
if(ypos[i]==0) {
df3$labely[i]=df3$y[i]
} else if(ypos[i]==1) {
df3$labely[i]=df3$yend[i]
} else if(ypos[i]==2) {
df3$labely[i]=df3$y1[i]
}
}
}
df3$hjust=-0.1
if(!is.null(hjust)){
df3$hjust=hjust
}
for(i in seq_along(df2$x)){
p<-p+geom_vline(xintercept=df2$x[i],color=linecolor,linetype=2)
}
p
p<-p+geom_segment(data=df2,aes_string(x="x",y="y",xend="x",yend="yend"),
arrow=arrow(angle=20,length=unit(0.3,"cm"),type="closed"),
color="red",linetype=linetype,size=arrowsize)
p+geom_text(data=df3,aes_string(x="x",y="labely",label="label",hjust="hjust",vjust=1),
parse=TRUE) +
geom_text(data=df3,aes_string(x="x",y=info$ymin,label="label3"),
parse=TRUE) + xlab(paste0(pred,"(W)"))
} else if(mode==2) {
coef<-pvalue<-c()
if(is.null(modx.values)){
if(length(unique(data[[modx]]))<6) {
modx.values=unique(data[[modx]])
} else if(rangemode==1){
modx.values=mean(data[[modx]],na.rm=T)+c(-1,0,1)*sd(data[[modx]],na.rm=T)
} else{
modx.values=quantile(data[[modx]],probs=c(0.16,0.5,0.84),type=6)
}
}
for(i in seq_along(modx.values)){
equation=deparse(fit$call)
temp=stringr::str_replace(equation,modx,paste0("I(",modx,"-",modx.values[i],")"))
fit1=eval(parse(text=temp))
coef=c(coef,fit1$coef[2])
pvalue=c(pvalue,summary(fit1)$coef[2,4])
}
effectDf=data.frame(modx.values,coef,pvalue)
effectDf
colnames(effectDf)[1]=modx
p=ggplot(data,aes_string(x=pred,y=dep))
df1=calEquation(fit,modx.values = modx.values)
df1[[modx]]=modx.values
df1
df1<-dplyr::left_join(df1,effectDf)
df1$coef=myformat(df1$coef,digits=digits)
df1$label=paste0("theta[italic(X) %->% italic(Y)] == ",df1$coef,
"~( ", modx,"== ",round(df1[[modx]],digits),")")
df1
if(!is.null(labels)){
if(nrow(df1)==length(labels)) df1$label=labels
}
p<-add_lines(p,df1,parse=TRUE,size=linesize,...)
p
} else if(mode==3){
if(is.null(pred.values)){
if(rangemode==1) {
pred.values=mean(data[[pred]],na.rm=TRUE)+c(-1,1)*sd(data[[pred]],na.rm=TRUE)
} else if(rangemode==2) {
pred.values=quantile(data[[pred]],probs=c(0.16,0.84),type=6)
}
}
coef<-pvalue<-c()
for(i in seq_along(pred.values)){
equation=deparse(fit$call)
temp=stringr::str_replace(equation,pred,paste0("I(",pred,"-",pred.values[i],")"))
fit1=eval(parse(text=temp))
coef=c(coef,fit1$coef[3])
pvalue=c(pvalue,summary(fit1)$coef[3,4])
}
effectDf=data.frame(pred.values,coef,pvalue)
colnames(effectDf)[1]="x"
df=effectDf
df
b1=fit$coef[modx]
b3=fit$coef[paste0(pred,":",modx)]
fun=function(x){b1+b3*x}
df$yend=0
df$y=fun(df$x)
df$labely=df$y
if(!is.null(ypos)){
if(length(ypos)==1) ypos=rep(ypos,nrow(df))
for(i in seq_along(ypos)){
if(ypos[i]==1) {
df$labely[i]=df$yend[i]
} else if(ypos[i]==2) {
df$labely[i]=(df$y[i]+df$yend[i])/2
}
}
}
df1=data.frame(slope=b3,intercept=b1,label=paste0("theta[italic(X)%->%italic(Y)]==",
round(b1,digits),ifelse(b3>=0,"+",""),round(b3,digits),"*italic(W)"))
if(!is.null(labels)){
if(nrow(df1)==length(labels)) df1$label=labels
}
df$label=paste0("italic(W) ==",round(df$x,digits))
df$label2=paste0("theta[italic(X)%->%italic(Y)]==",round(df$coef,digits),"(italic(p) ==",round(df$pvalue,3),")")
df$hjust=-0.1
if(!is.null(hjust)){
df$hjust=hjust
}
p<-ggplot(data=data,aes_string(x=pred))
# p<-add_lines(p,df1,parse=TRUE,vjust=-0.2)
p<-add_lines(p,df1,parse=TRUE,vjust=-0.3,size=linesize,...)
p
info=getAspectRatio(p)
for(i in seq_along(pred.values)){
p<-p+geom_vline(xintercept=pred.values[i],color=linecolor,linetype=2)
}
p<-p+ geom_text(data=df,aes_string(x="x",label="label"),y=info$ymin,parse=TRUE)+
geom_text(data=df,aes_string(x="x",y="labely",label="label2",hjust="hjust"),
parse=TRUE)
p
p<-p+geom_hline(yintercept=0,color=linecolor,linetype=3)
p<-p + geom_segment(data=df,aes_string(x="x",y="y",xend="x",yend="yend"),
arrow=arrow(angle=20,length=unit(0.3,"cm"),type="closed"),
color="red",linetype=linetype,size=arrowsize)
p+labs(x=paste(pred,"(W)"),
y=expression(paste("Conditional Effect (", theta[italic(X) %->%italic(Y)],")")))
}
}
system("grep -r 'donttest' *")
devtools::document()
devtools::check()
library(processR)
rrtable::data2HTML
devtools::document()
devtools::check()
fit=lm(govact~negemot*age+posemot+ideology+sex,data=glbwarm)
condPlot(fit,hjust=c(-0.1,-0.1,1.1))
condPlot(fit,modx.values=c(30,70),hjust=c(-0.1,-0.1,1.1))
require(ggplot2)
ggsave("plot5.png",width=5,height=5)
condPlot(fit,mode=2,modx.values=c(30,50,70),xpos=0.2)
condPlot(fit,mode=2,xpos=0.2)
condPlot(fit,mode=2,modx.values=c(30,50,70),xpos=0.2)
ggsave("plot6.png",width=5,height=5)
condPlot(fit,mode=3,xpos=0.5,hjust=c(-0.1,1.1))
condPlot(fit,pred.values=c(2,3,4),mode=3,xpos=0.6)
condPlot(fit,mode=3,xpos=0.5,hjust=c(-0.1,1.1))
condPlot(fit,pred.values=c(2,3,4),mode=3,xpos=0.6)
ggsave("plot7.png",width=5,height=5)
fit=lm(justify~skeptic*frame,data=disaster)
condPlot(fit,rangemode=2,xpos=0.7,labels=c("Climate change(X=1)","Natural causes(X=0)"))
ggsave("plot1.png",width=5,height=5)
condPlot(fit,mode=2,xpos=0.6)
ggsave("plot2.png",width=5,height=5)
condPlot(fit,mode=3,rangemode=2,xpos=0.5,ypos=c(0,2))
ggsave("plot3.png",width=5,height=5)
fit=lm(justify~skeptic*frame,data=disaster)
res=jnPlot(fit,plot=FALSE)
res$plot
ggsave("plot4.png",width=5,height=5)
devtools::document()
devtools::check()
devtools::document()
devtools::check()
devtools::document()
devtools::check()
