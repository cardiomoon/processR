Y~X+M1+M2+M3+M4'
node.pos=list(X=c(0,0.5),M1=c(0.35,0.9),M2=c(0.35,0.5),M3=c(0.35,0.1),M4=c(0.7,0.5),Y=c(1,0.5))
curved.arrow=list(a4=0.15,b2=0.15)
segment.arrow=list(c=0.5)
drawModel(equation=equation,nodemode=2,node.pos=node.pos,radx=0.08,curved.arrow=curved.arrow,segment.arrow=segment.arrow)
devtools::document()
devtools::check()
labels=list(X="baby",M=c("wine","tent","sand"),Y="tile",W="milk",Z="hair")
moderator=list(name=c("milk","hair"),matrix=list(c(1,0,0,0,1,0,1,0,0,0),c(1,1,0,0,0,0,0,0,0,0)))
moderator=list(name=c("milk"),matrix=list(c(1,0,0,0,1,0,1,0,0,0)))
bmatrix=c(1,1,0,0,1,1,1,1,0,1)
eq=multipleMediation(labels=labels,bmatrix=bmatrix,moderator=moderator,mode=1)
cat(eq)
labels=list(X="baby",M=c("wine","tent","sand"),Y="tile",W="milk",Z="hair")
# moderator=list(name=c("milk","hair"),matrix=list(c(1,0,0,0,1,0,1,0,0,0),c(1,1,0,0,0,0,0,0,0,0)))
moderator=list(name=c("milk"),matrix=list(c(1,0,0,0,1,0,1,0,0,0)))
bmatrix=c(1,1,0,0,1,1,1,1,0,1)
multipleMediation(labels=labels,bmatrix=bmatrix,moderator=moderator)
eq=multipleMediation(labels=labels,bmatrix=bmatrix,moderator=moderator,mode=1)
cat(eq)
drawModel(equation=eq,labels=labels)
labels=list(X="baby",M=c("wine","tent","sand"),Y="tile",W="milk",Z="hair")
# moderator=list(name=c("milk","hair"),matrix=list(c(1,0,0,0,1,0,1,0,0,0),c(1,1,0,0,0,0,0,0,0,0)))
moderator=list(name=c("milk"),matrix=list(c(1,0,0,0,1,0,1,0,0,0)))
bmatrix=c(1,1,0,0,1,1,1,1,0,1)
X=NULL;M=NULL;Y=NULL;labels=list();data;moderator=list()
covar=NULL;mode=0;range=TRUE;rangemode=1;serial=FALSE;contrast=1
bmatrix=NULL
X=NULL;M=NULL;Y=NULL;labels=list();data;moderator=list()
covar=NULL;mode=0;range=TRUE;rangemode=1;serial=FALSE;contrast=1
bmatrix=NULL
X=NULL;M=NULL;Y=NULL;labels=list();data;moderator=list()
X=NULL;M=NULL;Y=NULL;labels=list();moderator=list()
covar=NULL;mode=0;range=TRUE;rangemode=1;serial=FALSE;contrast=1
bmatrix=NULL
# labels=list(X="X",M=c("M1","M2"),Y="Y",W="W")
# moderator=list(name=c("W"),matrix=list(c(1,1,0,1,0,0)))
# bmatrix=c(1,1,1,1,1,1)
labels=list(X="baby",M=c("wine","tent","sand"),Y="tile",W="milk",Z="hair")
X=NULL;M=NULL;Y=NULL;labels=list();moderator=list()
covar=NULL;mode=0;range=TRUE;rangemode=1;serial=FALSE;contrast=1
bmatrix=NULL
# labels=list(X="X",M=c("M1","M2"),Y="Y",W="W")
# moderator=list(name=c("W"),matrix=list(c(1,1,0,1,0,0)))
# bmatrix=c(1,1,1,1,1,1)
labels=list(X="baby",M=c("wine","tent","sand"),Y="tile",W="milk",Z="hair")
# moderator=list(name=c("milk","hair"),matrix=list(c(1,0,0,0,1,0,1,0,0,0),c(1,1,0,0,0,0,0,0,0,0)))
moderator=list(name=c("milk"),matrix=list(c(1,0,0,0,1,0,1,0,0,0)))
bmatrix=c(1,1,0,0,1,1,1,1,0,1)
if(is.null(X)) X=labels$X
if(is.null(M)) if(!is.null(labels$M)) M=labels$M
if(is.null(Y)) Y=labels$Y
res=c()
xcount=length(X)
if(!is.null(M)) {
mcount=length(M)
} else{
mcount=0
}
ycount=length(Y)
vars=c(X,M,Y,moderator$name,covar$name)
#         groupvars=c(groupvars,vars[i])
#     } else if((count>2)&(count<=maxylev)){
#         groupvars=c(groupvars,vars[i])
#     }
# }
# for(i in seq_along(groupvars)){
#     grouplabels[[groupvars[i]]]=LETTERS[3+i]
#     attr(grouplabels[[groupvars[i]]],"length")=length(unique(data[[groupvars[i]]]))-1
# }
# str(grouplabels)
(XM=moderator$name[str_detect2(moderator$site,"a")])
(MY=moderator$name[str_detect2(moderator$site,"b")])
(XY=moderator$name[str_detect2(moderator$site,"c")])
# moderator=list(name=c("vs"),site=list(c("b1","b2")))
# name="vs"
# prefix="b"
# moderator
# name=MY
# name
# prefix="b"
mod2pos=function(moderator,name,prefix){
pos=list()
pos1=c()
# i=1
for(i in seq_along(name)) {
pos1=grep(name[i],moderator$name)
pos1
if(length(pos1)==1){
temp=moderator$site[[pos1]]
temp1=temp[str_detect(temp,prefix)]
temp1
res=str_extract(temp1,"[0-9]")
res
if(length(res)==1){
if(is.na(res)){
pos[[i]]=NULL
} else {
pos[[i]]=as.numeric(res)
}
} else{
pos[[i]]=as.numeric(res)
}
}
}
pos
}
pos=mod2pos(moderator,name=XM,prefix="a")
pos
eq1=makeCatEquation3(X=X,Y=M,W=XM,prefix="a",mode=mode,pos=pos,bmatrix=bmatrix,
moderator=moderator,depy=FALSE)
# maxylev
eq1
X
M
XM
pos
moderator
mode
bmatrix
X="baby";Y=c("wine","tent","sand");W=NULL;labels=list();prefix="a";mode=0;pos=list();
bmatrix=c(1,1,0,0,1,1,1,1,0,1);depy=FALSE
moderator=list(name=c("milk"),matrix=list(c(1,0,0,0,1,0,1,0,0,0)))
X="baby";Y=c("wine","tent","sand");W=NULL;labels=list();prefix="a";mode=0;pos=list();
bmatrix=c(1,1,0,0,1,1,1,1,0,1);depy=FALSE;depx=FALSE
moderator=list(name=c("milk"),matrix=list(c(1,0,0,0,1,0,1,0,0,0)))
if(length(W)==0) {
if(!is.null(labels$W)) W=labels$W
if(!is.null(moderator)) W=moderator$name
}
if(is.null(Y)) Y=labels$Y
xgroup<-wgroup<-c()
xcount<-wcount<-ycount<-0
(xcount=length(X))
(wcount=length(W))
(ycount=length(Y))
temp=c()
j=1
count=0
dcount=0
for(j in 1:ycount){
res1=c()
if(depy==FALSE){
for(i in 1:xcount){
res=c()
res=c(res,X[i])
for(l in seq_along(W)){
if(is.null(moderator$matrix)){
if(i %in% pos[[l]]){
res=c(res,W[l],paste0(X[i],":",W[l]))
}
} else{
if(moderator$matrix[[l]][1]==1){
res=c(res,W[l],paste0(X[i],":",W[l]))
}
}
#
# if(i %in% pos[[l]]){
#   res=c(res,W[l],paste0(X[i],":",W[l]))
# }
}
if(mode==0){
if(length(res)>0) temp1=paste0("a",(1+count):(length(res)+count),"*",res)
count=count+length(res)
} else{
temp1=res
}
res1=c(res1,temp1)
if(j>1){
for(k in 2:j){
pos=1+sum(1:(j-1))+(k-1)
#cat("j=",j,",k=",k,"\n")
#cat("pos=",pos,",bmatrix[pos]=",bmatrix[pos],"\n")
if(bmatrix[pos]==1){
if(is.null(moderator$matrix)){
if(mode==0) {
res1=c(res1,paste0("d",j,k-1,"*",Y[k-1]))
} else{
res1=c(res1,Y[k-1])
}
} else{
for(l in seq_along(W)){
if(moderator$matrix[[l]][pos]==1){
res=c(Y[k-1],W[i],paste0(Y[k-1],":",W[i]))
} else{
res=c(Y[k-1])
}
}
if(mode==0) {
if(length(res)>0) temp1=paste0("d",(1+dcount):(length(res)+dcount),"*",res)
dcount=dcount+length(res)
res1=c(res1,temp1)
} else{
res1=c(res1,res)
}
}
}
}
}
}
} else if(depx==TRUE){
count=length(bmatrix)
count
xcount=matrix2no(bmatrix)
bpos=1+sum(1:(xcount-1))
bpos
bmatrix[bpos]
if(bmatrix[bpos]==1){
res=c()
for(l in seq_along(W)){
if(is.null(moderator$matrix)){
res=c(res,X)
} else if(moderator$matrix[[l]][bpos]==0){
res=c(res,X)
} else{
res=c(res,X,W[l],paste0(X,":",W[l]))
}
}
if(mode==0){
res=paste0("c",1:length(res),"*",res)
}
res1=c(res1,res)
}
} else{
bpos=1+sum(1:(xcount))
bpos=bpos+1
bpos
i=0
for(k in bpos:length(bmatrix)){
i=i+1
if(bmatrix[k]==1){
res1=c(res1,X[i])
for(l in seq_along(W)){
if(is.null(moderator$matrix)){
if(i %in% pos[[l]]){
res1=c(res1,W[l],paste0(X[i],":",W[l]))
}
} else{
if(moderator$matrix[[l]][k]==1){
res1=c(res1,W[l],paste0(X[i],":",W[l]))
}
}
}
}
}
res1=unique(res1)
if(mode==0){
if(length(res1)>0) res1=paste0("b",1:length(res1),"*",res1)
}
}
res1
if(length(res1)>0) temp=c(temp,paste0(Y[j],"~",paste0(res1,collapse="+")))
}
temp
temp=c()
j=1
count=0
dcount=0
res1=c()
for(i in 1:xcount){
res=c()
res=c(res,X[i])
for(l in seq_along(W)){
if(is.null(moderator$matrix)){
if(i %in% pos[[l]]){
res=c(res,W[l],paste0(X[i],":",W[l]))
}
} else{
if(moderator$matrix[[l]][1]==1){
res=c(res,W[l],paste0(X[i],":",W[l]))
}
}
#
# if(i %in% pos[[l]]){
#   res=c(res,W[l],paste0(X[i],":",W[l]))
# }
}
if(mode==0){
if(length(res)>0) temp1=paste0("a",(1+count):(length(res)+count),"*",res)
count=count+length(res)
} else{
temp1=res
}
res1=c(res1,temp1)
if(j>1){
for(k in 2:j){
pos=1+sum(1:(j-1))+(k-1)
#cat("j=",j,",k=",k,"\n")
#cat("pos=",pos,",bmatrix[pos]=",bmatrix[pos],"\n")
if(bmatrix[pos]==1){
if(is.null(moderator$matrix)){
if(mode==0) {
res1=c(res1,paste0("d",j,k-1,"*",Y[k-1]))
} else{
res1=c(res1,Y[k-1])
}
} else{
for(l in seq_along(W)){
if(moderator$matrix[[l]][pos]==1){
res=c(Y[k-1],W[i],paste0(Y[k-1],":",W[i]))
} else{
res=c(Y[k-1])
}
}
if(mode==0) {
if(length(res)>0) temp1=paste0("d",(1+dcount):(length(res)+dcount),"*",res)
dcount=dcount+length(res)
res1=c(res1,temp1)
} else{
res1=c(res1,res)
}
}
}
}
}
}
j=1
pos=j+sum(1:j)
(pos=j+sum(1:j))
j=1
j=2
(pos=j+sum(1:j))
j=1
(pos=ifelse(j==1,1,j+sum(1:(j-1))))
j=2
(pos=ifelse(j==1,1,j+sum(1:(j-1))))
j=3
(pos=ifelse(j==1,1,j+sum(1:(j-1))))
j=1
(pos=ifelse(j==1,1,j-1+sum(1:(j-1))))
j=2
(pos=ifelse(j==1,1,j-1+sum(1:(j-1))))
j=3
(pos=ifelse(j==1,1,j-1+sum(1:(j-1))))
j=4
(pos=ifelse(j==1,1,j-1+sum(1:(j-1))))
j=1
(pos=ifelse(j==1,1,1+sum(1:(j-1))))
j=2
(pos=ifelse(j==1,1,1+sum(1:(j-1))))
j=3
(pos=ifelse(j==1,1,1+sum(1:(j-1))))
j=4
(pos=ifelse(j==1,1,1+sum(1:(j-1))))
X="baby";Y=c("wine","tent","sand");W=NULL;labels=list();prefix="a";mode=0;pos=list();
bmatrix=c(1,1,0,0,1,1,1,1,0,1);depy=FALSE;depx=FALSE
moderator=list(name=c("milk"),matrix=list(c(1,0,0,0,1,0,1,0,0,0)))
if(is.null(X)) X=labels$X
if(is.null(W)) {
if(!is.null(labels$W)) W=labels$W
if(!is.null(moderator)) W=moderator$name
}
if(length(W)==0) {
if(!is.null(labels$W)) W=labels$W
if(!is.null(moderator)) W=moderator$name
}
if(is.null(Y)) Y=labels$Y
xgroup<-wgroup<-c()
xcount<-wcount<-ycount<-0
(xcount=length(X))
(wcount=length(W))
(ycount=length(Y))
temp=c()
j=1
count=0
dcount=0
for(j in 1:ycount){
res1=c()
if(depy==FALSE){
for(i in 1:xcount){
res=c()
(pos=ifelse(j==1,1,1+sum(1:(j-1))))
if(bmatrix[pos]==1){
res=c(res,X[i])
for(l in seq_along(W)){
if(is.null(moderator$matrix)){
if(i %in% pos[[l]]){
res=c(res,W[l],paste0(X[i],":",W[l]))
}
} else{
if(moderator$matrix[[l]][pos]==1){
res=c(res,W[l],paste0(X[i],":",W[l]))
}
}
#
# if(i %in% pos[[l]]){
#   res=c(res,W[l],paste0(X[i],":",W[l]))
# }
}
}
temp1=c()
if(mode==0){
if(length(res)>0) temp1=paste0("a",(1+count):(length(res)+count),"*",res)
count=count+length(res)
} else{
temp1=res
}
res1=c(res1,temp1)
if(j>1){
for(k in 2:j){
pos=1+sum(1:(j-1))+(k-1)
#cat("j=",j,",k=",k,"\n")
#cat("pos=",pos,",bmatrix[pos]=",bmatrix[pos],"\n")
if(bmatrix[pos]==1){
if(is.null(moderator$matrix)){
if(mode==0) {
res1=c(res1,paste0("d",j,k-1,"*",Y[k-1]))
} else{
res1=c(res1,Y[k-1])
}
} else{
for(l in seq_along(W)){
if(moderator$matrix[[l]][pos]==1){
res=c(Y[k-1],W[i],paste0(Y[k-1],":",W[i]))
} else{
res=c(Y[k-1])
}
}
if(mode==0) {
if(length(res)>0) temp1=paste0("d",(1+dcount):(length(res)+dcount),"*",res)
dcount=dcount+length(res)
res1=c(res1,temp1)
} else{
res1=c(res1,res)
}
}
}
}
}
}
} else if(depx==TRUE){
count=length(bmatrix)
count
xcount=matrix2no(bmatrix)
bpos=1+sum(1:(xcount-1))
bpos
bmatrix[bpos]
if(bmatrix[bpos]==1){
res=c()
for(l in seq_along(W)){
if(is.null(moderator$matrix)){
res=c(res,X)
} else if(moderator$matrix[[l]][bpos]==0){
res=c(res,X)
} else{
res=c(res,X,W[l],paste0(X,":",W[l]))
}
}
if(mode==0){
res=paste0("c",1:length(res),"*",res)
}
res1=c(res1,res)
}
} else{
bpos=1+sum(1:(xcount))
bpos=bpos+1
bpos
i=0
for(k in bpos:length(bmatrix)){
i=i+1
if(bmatrix[k]==1){
res1=c(res1,X[i])
for(l in seq_along(W)){
if(is.null(moderator$matrix)){
if(i %in% pos[[l]]){
res1=c(res1,W[l],paste0(X[i],":",W[l]))
}
} else{
if(moderator$matrix[[l]][k]==1){
res1=c(res1,W[l],paste0(X[i],":",W[l]))
}
}
}
}
}
res1=unique(res1)
if(mode==0){
if(length(res1)>0) res1=paste0("b",1:length(res1),"*",res1)
}
}
res1
if(length(res1)>0) temp=c(temp,paste0(Y[j],"~",paste0(res1,collapse="+")))
}
temp
library(processR)
labels=list(X="baby",M=c("wine","tent","sand"),Y="tile",W="milk",Z="hair")
# moderator=list(name=c("milk","hair"),matrix=list(c(1,0,0,0,1,0,1,0,0,0),c(1,1,0,0,0,0,0,0,0,0)))
moderator=list(name=c("milk"),matrix=list(c(1,0,0,0,1,0,1,0,0,0)))
bmatrix=c(1,1,0,0,1,1,1,1,0,1)
eq=multipleMediation(labels=labels,bmatrix=bmatrix,moderator=moderator,mode=1)
cat(eq)
drawModel(equation=eq,labels=labels)
cat(eq)
df=equations2var(eq,labels=labels)
df
equations=unlist(strsplit(eq,"\n"))
equations
purrr::map_df(equations,eq2var,labels=labels)
labels
eq2var(equations[1],labels=labels)
eq2var(equations[2],labels=labels)
eq2var(equations[3],labels=labels)
df=equations2var(eq,labels=labels)
df
eq2var(equations[4],labels=labels)
df=equations2var(eq,labels=labels)
df
labels=list(X="baby",M=c("wine","tent","sand"),Y="tile",W="milk",Z="hair")
# moderator=list(name=c("milk","hair"),matrix=list(c(1,0,0,0,1,0,1,0,0,0),c(1,1,0,0,0,0,0,0,0,0)))
moderator=list(name=c("milk"),matrix=list(c(1,0,0,0,1,0,1,0,0,0)))
bmatrix=c(1,1,0,0,1,1,1,1,0,1)
cat(multipleMediation(labels=labels,bmatrix=bmatrix,moderator=moderator))
